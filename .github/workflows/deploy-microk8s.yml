name: Deploy to microk8s

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy-microk8s:
    name: Deploy to microk8s on Proxmox VM
    runs-on: self-hosted
    env:
      PROXMOX_DEPLOY_METHOD: ${{ secrets.PROXMOX_DEPLOY_METHOD }}
      IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/spring-java-thread-performance
    permissions:
      contents: read
      actions: read
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'develop')) || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        uses: actions/checkout@v4
      
      - name: Resolve deployment image tag
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          if [[ "$BRANCH" == "main" ]]; then
            IMAGE_TAG="latest"
          else
            IMAGE_TAG="develop"
          fi

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
      
      - name: Set up SSH to microk8s VM
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MICROK8S_SSH_KEY }}" > ~/.ssh/microk8s_key
          chmod 600 ~/.ssh/microk8s_key
          ssh-keyscan -H ${{ secrets.MICROK8S_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to microk8s
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          # Create temp directory on microk8s VM
          ssh -i ~/.ssh/microk8s_key ${{ secrets.MICROK8S_USER }}@${{ secrets.MICROK8S_HOST }} \
            "mkdir -p /tmp/k8s-deploy"
          
          # Copy fresh Kubernetes manifests
          scp -i ~/.ssh/microk8s_key deployment/kubernetes/*.yaml \
            ${{ secrets.MICROK8S_USER }}@${{ secrets.MICROK8S_HOST }}:/tmp/k8s-deploy/
          
          ssh -i ~/.ssh/microk8s_key ${{ secrets.MICROK8S_USER }}@${{ secrets.MICROK8S_HOST }} << ENDSSH
            # Prepare deployment directory
            rm -rf ~/spring-performance-k8s
            mkdir -p ~/spring-performance-k8s
            cp /tmp/k8s-deploy/*.yaml ~/spring-performance-k8s/
            cd ~/spring-performance-k8s
            
            # Update image references to use GHCR images
            sed -i 's|image: spring-performance/|image: __IMAGE_PREFIX__/|g' spring-*.yaml
            sed -i 's|:latest|:__IMAGE_TAG__|g' spring-*.yaml

            # Ensure imagePullPolicy is Always for rolling tags
            sed -i '/imagePullPolicy:/d' spring-*.yaml
            sed -i '/image: __IMAGE_PREFIX__/a\        imagePullPolicy: Always' spring-*.yaml

            # Replace placeholders with actual GHCR path and tag
            sed -i 's|__IMAGE_PREFIX__|${IMAGE_PREFIX}|g; s|__IMAGE_TAG__|${IMAGE_TAG}|g' spring-*.yaml
            
            # Apply Kubernetes manifests
            microk8s kubectl apply -f spring-mvc-traditional.yaml
            microk8s kubectl apply -f spring-virtual-threads.yaml
            microk8s kubectl apply -f spring-webflux.yaml
            
            # Apply ingress if needed (uncomment if you want ingress)
            # microk8s kubectl apply -f ingress.yaml
            
            echo "Waiting for deployments to be ready..."
            microk8s kubectl wait --for=condition=available --timeout=300s deployment/spring-mvc-traditional
            microk8s kubectl wait --for=condition=available --timeout=300s deployment/spring-virtual-threads
            microk8s kubectl wait --for=condition=available --timeout=300s deployment/spring-webflux
            
            # Cleanup temp files
            rm -rf /tmp/k8s-deploy
          ENDSSH
      
      - name: Verify deployment
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          ssh -i ~/.ssh/microk8s_key ${{ secrets.MICROK8S_USER }}@${{ secrets.MICROK8S_HOST }} << 'ENDSSH'
            echo "=== Deployments ==="
            microk8s kubectl get deployments
            
            echo ""
            echo "=== Pods ==="
            microk8s kubectl get pods
            
            echo ""
            echo "=== Services ==="
            microk8s kubectl get services
            
            echo ""
            echo "=== Health Checks ==="
            # Get service cluster IPs and test health
            for app in spring-mvc-traditional spring-virtual-threads spring-webflux; do
              POD=$(microk8s kubectl get pod -l app=$app -o jsonpath='{.items[0].metadata.name}')
              if [ -n "$POD" ]; then
                echo "Testing $app..."
                microk8s kubectl exec $POD -- curl -f -s http://localhost:8080/actuator/health > /dev/null && echo "✓ $app is healthy" || echo "✗ $app health check failed"
              fi
            done
          ENDSSH
      
      - name: Display access information
        if: ${{ env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          ssh -i ~/.ssh/microk8s_key ${{ secrets.MICROK8S_USER }}@${{ secrets.MICROK8S_HOST }} << 'ENDSSH'
            echo ""
            echo "=== Access Information ==="
            echo "To access services from your local machine:"
            echo ""
            
            # Get NodePort if services are NodePort type
            MVC_PORT=$(microk8s kubectl get service spring-mvc-traditional -o jsonpath='{.spec.ports[0].nodePort}')
            VIRTUAL_PORT=$(microk8s kubectl get service spring-virtual-threads -o jsonpath='{.spec.ports[0].nodePort}')
            WEBFLUX_PORT=$(microk8s kubectl get service spring-webflux -o jsonpath='{.spec.ports[0].nodePort}')
            
            if [ -n "$MVC_PORT" ]; then
              echo "Spring MVC Traditional: http://$(hostname -I | awk '{print $1}'):$MVC_PORT"
              echo "Spring Virtual Threads: http://$(hostname -I | awk '{print $1}'):$VIRTUAL_PORT"
              echo "Spring WebFlux: http://$(hostname -I | awk '{print $1}'):$WEBFLUX_PORT"
            else
              echo "Services are ClusterIP type. Use port-forwarding:"
              echo "  microk8s kubectl port-forward service/spring-mvc-traditional 8080:8080"
              echo "  microk8s kubectl port-forward service/spring-virtual-threads 8081:8081"
              echo "  microk8s kubectl port-forward service/spring-webflux 8082:8082"
            fi
          ENDSSH
      
      - name: Cleanup
        if: ${{ always() && env.PROXMOX_DEPLOY_METHOD == 'micro-k8s' }}
        run: |
          rm -f ~/.ssh/microk8s_key
